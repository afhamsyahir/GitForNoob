<div>
  @for (item of items(); track $index) {
  <div class="mb-20" [id]="item.id.toString()">
    <!-- Main Section -->
    <div>
      <h1 class="text-3xl font-semibold leading-tight mb-4 text-foreground">
        {{ item.title }}
      </h1>
      <div
        class="text-base leading-relaxed mb-4 text-muted-foreground markdown-content"
        [innerHTML]="renderDescription(item.description)"
      ></div>

      @if (item.commands && item.commands.length > 0) {
      <ng-container
        *ngTemplateOutlet="commandsBlock; context: { commands: item.commands }"
      ></ng-container>
      } @if (item.media && item.media.length > 0) {
      <ng-container
        *ngTemplateOutlet="mediaBlock; context: { media: filterMediaByTheme(item.media) }"
      ></ng-container>
      }
    </div>

    <!-- Sub Items -->
    @if (item.items && item.items.length > 0) {
    <div>
      @for (subItem of item.items; track $index) {
      <div [id]="subItem.id.toString()" class="my-12">
        <h2
          class="text-xl font-medium pb-2 border-b border-zinc-200 dark:border-zinc-800 mb-4 text-foreground"
        >
          {{ subItem.title }}
        </h2>
        <div
          class="text-base leading-7 mb-4 text-muted-foreground markdown-content"
          [innerHTML]="renderDescription(subItem.description)"
        ></div>

        @if (subItem.commands && subItem.commands.length > 0) {
        <ng-container
          *ngTemplateOutlet="commandsBlock; context: { commands: subItem.commands }"
        ></ng-container>
        } @if (subItem.media && subItem.media.length > 0) {
        <ng-container
          *ngTemplateOutlet="mediaBlock; context: { media: filterMediaByTheme(subItem.media) }"
        ></ng-container>
        }

        <!-- Nested Sub Items -->
        @if (subItem.items && subItem.items.length > 0) {
        <div>
          @for (nestedItem of subItem.items; track $index) {
          <div [id]="nestedItem.id.toString()" class="my-8">
            <h3 class="text-xl font-medium leading-snug mb-3 text-foreground">
              {{ nestedItem.title }}
            </h3>
            <div
              class="text-base leading-7 mb-4 text-muted-foreground markdown-content"
              [innerHTML]="renderDescription(nestedItem.description)"
            ></div>

            @if (nestedItem.commands && nestedItem.commands.length > 0) {
            <ng-container
              *ngTemplateOutlet="commandsBlock; context: { commands: nestedItem.commands }"
            ></ng-container>
            } @if (nestedItem.media && nestedItem.media.length > 0) {
            <ng-container
              *ngTemplateOutlet="
                mediaBlock;
                context: { media: filterMediaByTheme(nestedItem.media) }
              "
            ></ng-container>
            }
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
    }
  </div>
  }
</div>

<ng-template #commandsBlock let-commands="commands">
  <div class="space-y-3">
    @for (cmd of commands; track $index) {
    <div
      class="rounded-lg bg-zinc-100 dark:bg-zinc-900 relative group border border-zinc-200 dark:border-zinc-800"
    >
      <div
        class="flex items-center justify-between px-4 py-2 border-b border-zinc-200 dark:border-zinc-800"
      >
        <div class="flex items-center gap-2">
          <ng-container *ngTemplateOutlet="terminalIcon"></ng-container>
          <span class="text-sm font-medium text-zinc-700 dark:text-zinc-300">{{ cmd.name }}</span>
        </div>
        <button
          (click)="copyToClipboard(cmd.action)"
          class="p-1 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-colors"
          [matTooltip]="copiedCommand() === cmd.action ? 'Copied!' : 'Copy to clipboard'"
          matTooltipPosition="above"
        >
          @if (copiedCommand() === cmd.action) {
          <ng-container *ngTemplateOutlet="checkIcon"></ng-container>
          } @else {
          <ng-container *ngTemplateOutlet="copyIcon"></ng-container>
          }
        </button>
      </div>

      <div class="p-4 overflow-x-auto">
        <pre
          class="m-0 text-sm whitespace-pre text-zinc-900 dark:text-zinc-100"
        ><code>{{ cmd.action }}@if (cmd.description) {<span class="text-zinc-500 dark:text-zinc-400"> # {{ cmd.description }}</span>}</code></pre>
      </div>
    </div>
    }
  </div>
</ng-template>

<ng-template #mediaBlock let-media="media">
  <div class="mt-4 space-y-4">
    @for (mediaItem of media; track $index) { @if (isImageFile(mediaItem.path)) {
    <!-- Image Display -->
    <div
      class="rounded-lg border border-zinc-200 dark:border-zinc-800 overflow-hidden w-full relative bg-zinc-100 dark:bg-zinc-900"
      [style.min-height]="!isImageLoaded(mediaItem.path) ? '200px' : 'auto'"
    >
      <!-- Loading Placeholder -->
      @if (!isImageLoaded(mediaItem.path)) {
      <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 z-10">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-8 h-8 text-zinc-400 dark:text-zinc-600 bird-loading-small"
        >
          <path d="M16 7h.01" />
          <path d="M3.4 18H12a8 8 0 0 0 8-8V7a4 4 0 0 0-7.28-2.3L2 20" />
          <path d="m20 7 2 .5-2 .5" />
          <path d="M10 18v3" />
          <path d="M14 17.75V21" />
          <path d="M7 18a6 6 0 0 0 3.84-10.61" />
        </svg>
        <p class="text-sm text-zinc-400 dark:text-zinc-500">loading...</p>
      </div>
      }
      <img
        [src]="mediaItem.path"
        [alt]="mediaItem.path"
        class="w-full h-auto block cursor-pointer hover:opacity-90 transition-all duration-300"
        [class.opacity-0]="!isImageLoaded(mediaItem.path)"
        loading="lazy"
        (load)="onImageLoad(mediaItem.path, $event)"
        (click)="openImageZoom(mediaItem.path)"
      />
    </div>
    } @else if (isTextFile(mediaItem.path)) {
    <!-- Text/Markdown File with Copy -->
    <div
      class="rounded-lg bg-zinc-100 dark:bg-zinc-900 relative group border border-zinc-200 dark:border-zinc-800"
    >
      <div
        class="flex items-center justify-between px-4 py-2 border-b border-zinc-200 dark:border-zinc-800"
      >
        <div class="flex items-center gap-2">
          <ng-container *ngTemplateOutlet="fileIcon"></ng-container>
          <span class="text-sm font-medium text-zinc-700 dark:text-zinc-300">{{
            mediaItem.title || mediaItem.path
          }}</span>
        </div>
        <button
          (click)="copyFileContentToClipboard(getFileContent(mediaItem.path))"
          class="p-1 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-colors"
          [matTooltip]="
            copiedFileContent() === getFileContent(mediaItem.path) ? 'Copied!' : 'Copy content'
          "
          matTooltipPosition="above"
        >
          @if (copiedFileContent() === getFileContent(mediaItem.path)) {
          <ng-container *ngTemplateOutlet="checkIcon"></ng-container>
          } @else {
          <ng-container *ngTemplateOutlet="copyIcon"></ng-container>
          }
        </button>
      </div>
      <div class="p-4 overflow-x-auto">
        @if (!isFileLoaded(mediaItem.path)) {
        <!-- Loading Placeholder for Text Files -->
        <div class="flex items-center justify-center py-8">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-8 h-8 text-zinc-400 dark:text-zinc-600 bird-loading-small"
          >
            <path d="M16 7h.01" />
            <path d="M3.4 18H12a8 8 0 0 0 8-8V7a4 4 0 0 0-7.28-2.3L2 20" />
            <path d="m20 7 2 .5-2 .5" />
            <path d="M10 18v3" />
            <path d="M14 17.75V21" />
            <path d="M7 18a6 6 0 0 0 3.84-10.61" />
          </svg>
        </div>
        } @else {
        <pre
          class="m-0 text-sm whitespace-pre-wrap text-zinc-900 dark:text-zinc-100"
        ><code>{{ getFileContent(mediaItem.path) }}</code></pre>
        }
      </div>
    </div>
    } }
  </div>
</ng-template>

<ng-template #terminalIcon>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="size-4 text-zinc-500 dark:text-zinc-400"
  >
    <path d="M12 19h8" />
    <path d="m4 17 6-6-6-6" />
  </svg>
</ng-template>

<ng-template #copyIcon>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="size-4 text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
  >
    <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
  </svg>
</ng-template>

<ng-template #fileIcon>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="size-4 text-zinc-500 dark:text-zinc-400"
  >
    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
    <polyline points="14 2 14 8 20 8" />
  </svg>
</ng-template>

<ng-template #checkIcon>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="size-4 text-green-600 dark:text-green-500"
  >
    <path d="M20 6 9 17l-5-5" />
  </svg>
</ng-template>

<!-- Image Zoom Modal -->
@if (zoomedImage()) {
<div
  [class]="
    'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm zoom-backdrop' +
    (isClosingZoom() ? ' closing' : '')
  "
  (click)="closeImageZoom()"
>
  <div
    [class]="
      'relative max-w-5xl max-h-[90vh] w-auto zoom-content' + (isClosingZoom() ? ' closing' : '')
    "
  >
    <button
      class="absolute -top-10 right-0 text-white hover:text-zinc-300 transition-colors zoom-close-button"
      (click)="closeImageZoom()"
      aria-label="Close image"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="size-8"
      >
        <path d="M18 6 6 18" />
        <path d="m6 6 12 12" />
      </svg>
    </button>

    <img
      [src]="zoomedImage()!"
      [alt]="zoomedImage()"
      class="max-w-full max-h-[80vh] w-auto h-auto rounded-lg shadow-2xl"
      (click)="$event.stopPropagation()"
    />
  </div>
</div>
}
